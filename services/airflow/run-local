#!/bin/bash
# services/airflow/run-local.sh
# Local development only

set -e
cd "$(dirname "$0")"

echo "=============================================="
echo "ğŸŒ¬ï¸ Airflow Local Build & Run"
echo "=============================================="

# Build feature_store.zip
echo "ğŸ“¦ Building feature_store.zip from GitHub..."
rm -rf /tmp/patternalarm feature-store/dist
mkdir -p feature-store/dist

git clone --depth 1 https://github.com/acourreg/patternalarm.git /tmp/patternalarm
cd /tmp/patternalarm/feature-store
zip -r "$OLDPWD/feature-store/dist/feature_store.zip" feature_store
cd "$OLDPWD"
rm -rf /tmp/patternalarm

echo "âœ… feature_store.zip ready"

# Build Docker image
echo "ğŸ”¨ Building Airflow image..."
docker build -t patternalarm-airflow:latest .

# Run container
echo "ğŸ§¹ Cleaning up old container..."
docker stop airflow 2>/dev/null || true
docker rm airflow 2>/dev/null || true

echo "ğŸš€ Starting Airflow..."
docker run -d \
  --name airflow \
  -p 8080:8080 \
  -v "$(pwd)/../../data:/opt/spark-data" \
  patternalarm-airflow:latest

echo "â³ Waiting for Airflow (30s)..."
sleep 30

echo ""
echo "âœ… Airflow ready: http://localhost:8080"
echo "ğŸ“‹ Login: admin / admin"